---
title: "Missing data in questionnaires"
author: "Dr. Iris Eekhout"
subtitle: "Workshop name"
date: "`r format(Sys.Date())`"
output: 
  ioslides_presentation:
    logo: Puzzle_zgnb3_m.jpg
    theme: readable
    css: eigencssfile.css
widescreen: true
always_allow_html: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = ">")
library(dplyr)
library(dmo)
library(mice)
```

# Mssing data in questionnaires {data-background=Puzzle_zgnb3.jpg data-background-size=cover}

## Multi-item questionnaires

* Constructs measured indirectly, through items.
* Item can be continuous, dichotomous or measured on Likert scale.
* Summary score of items is the construct

## Summarizing item scores

* CTT: sum score or mean score
* Latent variable obtained via Item Response model (e.g. Rasch model or 2 parameter logistic model)
* Latent variable measured in a structural equation model

## Missing data in multi-item questionnaires

* Missing item level scores
* Missing full questionnaire

```{R echo=FALSE}
data.frame(item1 = c(1,NA,NA), item2 = c(0,1,NA), item3 = c(0, 0, NA), item4 = c(0,NA, NA), item5 = c(1, 1, NA), "Total score"=c(2, NA, NA) )

```

**Both lead to a missing total score**


## Advice in user manuals

* User manuals often have a statement about dealing with missing items scores
* This method is not always evidence-based
* Examples:
  + SF-36: "*Items that are left blank (missing data) are not taken into account when calculating the scale scores. Hence, scale scores represent the average for all items in the scale that the respondent answered.*" (Ware & Sherbourne, 1992)
  + SDQ: "*The SDQ comprises of 5 items for 5 subscales. For each of the 5 scales the score can range from 0 to 10 if all items were completed. These scores can be scaled up pro-rata if at least 3 items were completed, e.g. a score of 4 based on 3 completed items can be scaled up to a score of 7 (6.67 rounded up) for 5 items."* (Goodman, 2010)
  

## Person mean imputation

* Single imputation of mean over the observed items (within person)
* Same as average over the available items
* Best ad hoc single imputation method available
* Disadvantages of single imputation: no imputation uncertainty
* Works best when correlation between items is higher

## Example of person mean imputation {.build .smaller}

```{r include=FALSE}

#generate questionnaire data
k <- c(5,5)
x <- dmo::gen_qdata(n=20, k= k, likert = T)

#generate covariate data
set.seed(61085)
cov <- MASS::mvrnorm(n=20, mu=c(5,5,5), Sigma=matrix(c(10,1,1,1,10,1,1,1,10),3,3))
colnames(cov) <- c("cov1", "cov2", "cov3")

#combine in data.frame
x1 <- data.frame(cbind(x,cov))

alpha <- 0.25

#regerate 2 random patterns for missing item data
pattern <- matrix(c(sample(c(0,1), size=2*sum(k),replace = TRUE)),nrow=2)
pattern <- cbind(pattern, matrix(c(1,1,1,1,1,1),nrow=2, byrow = T))
pattern

#apply each pattern with equal frequency and equal odds
f <- c(0.5,0.5)
g <- c(4,4)

#generate missings in the data
set.seed(9817)
x <- MAR(x1,alpha = alpha ,pattern = pattern, f = f ,g = g)
colnames(x) <- gsub("_", "",colnames(x1))

#head(x, 15)
ts <- dmo::calculate_ts(x, k= c(5,5))
data <- data.frame(x,ts) %>% select(Q1i1:Q2i5, TSQ1, TSQ2, cov1) %>% mutate(cov1 = round(cov1, 2))
data
```

```{r echo=FALSE}
x <-data[1:5,c(1:5, 11)]
x
```

```{r echo=TRUE}
x %>% 
  #compute average over available items (AAI)
  mutate(AAI = rowMeans(select(.,Q1i1, Q1i2, Q1i3, Q1i4, Q1i5), na.rm = T)) %>%
  #then apply rule to all items that if the score is missing, to replace it with AAI
   mutate_at(.vars = vars(Q1i1:Q1i5),
             .funs = list(~ ifelse(is.na(.), AAI, .))) %>%
  mutate(TSQ1 = rowSums(select(.,Q1i1, Q1i2, Q1i3, Q1i4, Q1i5)))
```

## Note on person mean imputation

* Can get unstable when:
  + Many items are missing.
  + Correlations between items is low.
* Single imputation method, no missing data uncertainty.

## Multiple imputation in multi-item questionnaires

* Imputing item scores versus imputing total scores
* Item scores can hold valuable information
* Total scores are often used in analyses

## Advised strategy for imputation

* When there are item scores observed, use item level imputation
* When only few item scores or none, use total score imputation
* Combine both strategies

## Challenges in multi-item questionnaire missings

* Imputation model can grow large when all items are used
* When the total score is used in analyses, the total score should be used as predictor for other variables

## Solutions 

*Imputation model can grow large when all items are used*

* Isolate item imputation per questionnaire or subscale via prediction matrix
* Especially relevant in longitudinal data

*When the total score is used in analyses, the total score should be used as predictor for other variables*

* Update total score after each iteration by using **passive imputation**.

## Illustration item and total scores {.smaller}

* Data set with two questionnaires each 5 items, and 1 covariate.
* Isolate item imputation per questionnaire or subscale.
* Use predictor matrix: rows indicate imputed variable, columns are predictors.

For Q1:
```{r}
predQ <- make.predictorMatrix(data)
predQ[1:5,6:10] <- 0
predQ[1:5,]
```


## Illustration item and total scores {.smaller}

* Isolate item imputation per questionnaire or subscale

For Q2:
```{r}
predQ[6:10,1:5] <- 0
predQ[6:10,]
```

## Illustration item and total scores {.smaller}

* Total score cannot be used as predictor for its own items.

```{r}
predQ[1:5,11] <- 0
predQ[6:10,12] <- 0

predQ[1:10,]

```


## Illustration item and total scores {.smaller}

* Item scores cannot be used as predictor together with its own total scores.

```{r}
predQ[11:13,1:10] <- 0
predQ[11:13,]
```


## Illustration item and total scores {.smaller}


* Total score should be used as predictor for other variables when used in the analysis model.

```{r}
predQ[11:13,11:13]
```


## Illustration item and total scores {.smaller}

* Full predictor matrix

```{r}
predQ

```



## Passive imputation total score

* Total score is used as predictor, but not directly imputed.
* Item scores are imputed.
* Total scores re-calculated from the imputed item scores: **Passive imputation**


## Passive imputation process {.smaller .build}

**During each iteration for Q1:**

1\. Impute item scores using items from its own questionnaire, total score(s) from other questionnaires and covariate(s).

  * $Q1i1_i = Q1i2_i + Q1i3_i + Q1i4_i + Q1i5_i + TSQ2_i + cov1_i$
  * $Q1i2_i = Q1i1_i + Q1i3_i + Q1i4_i + Q1i5_i + TSQ2_i + cov1_i$
  * $etc.$
  
2\. Total score is re-calculated using the imputed item scores.

  * $TSQ1_i = Q1i1_i + Q1i2_i + Q1i3_i + Q1i4_i + Q1i5_i$
  
3\. Updated total score is used as predictor for covariate(s) and items of other questionnaires in next iteration.

  * $Q2i1_i =  Q2i2_i + Q2i3_i + Q2i4_i + Q2i5_i + TSQ1_i + cov1_i$


*Note the $_i$ indicates impute value from the previous iteration.*

## Passive imputation code {.smaller .build}

* Change the imputation method for the total scores.

```{r}
imp0 <- mice(data, pred = predQ, m =1, maxit =0)
methodQ <- imp0$method
methodQ[c("TSQ1", "TSQ2")]
```

```{r}
methodQ["TSQ1"] <- "~I(Q1i1 + Q1i2 + Q1i3 + Q1i4 + Q1i5)"
methodQ["TSQ2"] <- "~I(Q2i1 + Q2i2 + Q2i3 + Q2i4 + Q2i5)"
methodQ[c("TSQ1", "TSQ2")]

```


## Missing data in IRT models

* Some of the estimation methods for IRT methods deal with missing values by MAR assumption
* For example maximum likelihood estimation


## Missing data in SEM models

* Full Information Maximum Likelihood estimation
* In `R` the `lavaan` package - simulates Mplus


## Missing item scores

* Item level information may need a different strategy in order to use all available information
* When there are missing values at item level only, use a strategy that involves the item scores.
* When mostly the full questionnaire is missing, the missing data can be dealt with at the total score level.

