---
title: "Missing data mechanisms"
subtitle: "Workshop name"
author: "Dr. Iris Eekhout"
date: "`r format(Sys.Date())`"
output: 
  ioslides_presentation:
    logo: Puzzle_zgnb3_m.jpg
    theme: readable
    css: eigencssfile.css
widescreen: true
always_allow_html: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dmo)
library(ggplot2)
#example dataset n = 100
library(MASS)
library(psych)
library(knitr)
library(kableExtra)
library(dplyr)
library(tidyr)
set.seed(7869)

x <- mvrnorm(n=1000,mu=c(0,0,0), Sigma=matrix(c(5,1,1,1,5,1,1,1,5),3,3)) %>% 
  data.frame() 

theme_set(theme_light())
```


# Missing data mechanisms {data-background=Puzzle_zgnb3.jpg data-background-size=cover}

## Types of missing data {.build}

In research, missing data occur when a data value is unavailable. Many empirical studies encounter missing data. Missing data can occur in many stages of research due to many different causes in many different forms. 

- *Non-response*: an invited respondent does not participate in the study.
- *Intermittent missing data*: missing data on one or more of the measured variables that are used as a predictor, covariate or outcome.
- *drop-out* or *loss to follow-up*: participants in a longitudinal study do not show up at one or more repeated measurement occasions.

Each type of missing data may have different reasons, and also different implication for the methods to deal with the missing data.


## Missing data mechanisms

The underlying causes of missing data as *missing data mechanisms* and were first described by Rubin (1976). 

Rubin distinguished three missing data mechanisms:

* **missing completely at random (MCAR)**
* **missing at random (MAR)**
* **missing not at random (MNAR)**

## Missing completely at random (MCAR)

Missing data are MCAR when the probability of missing data on a variable is unrelated to any other measured variable and is unrelated to the variable with missing values itself. 

In other words the missingness on the variable is completely unsystematic. 

<br>
<center><img src="images/mailman.jpg" height="270px" /></center>


## Complete data example {.smaller}

```{r echo = FALSE}
describe(x) %>% kable(caption = "Description of fully observed data", digits = 2) %>% kable_styling()
```


## MCAR data example {.smaller}

When we create MCAR data for 50% of the subject in variable `X1` we see that the statistics for variable `X1` have not changed much:
```{r}
set.seed(8965)
mcar <- MCAR(x, alpha = 0.5, pattern = matrix(c(0,1,1), nrow = 1))
```

```{r echo = FALSE}
describe(mcar) %>% kable(caption = "Description of MCAR data - 50% ", digits = 2) %>% kable_styling()
```

## MCAR distribution

```{r echo=FALSE, message=FALSE, warning=FALSE}
mcarplot <- x %>% mutate(file = "complete") %>%
  bind_rows(mcar %>% mutate(file = "mcar"))
colors <- c("complete" = "blue", "mcar" = "red")
ggplot(mcarplot, aes(x = X1, fill = file)) +
  geom_histogram( alpha = 0.5)+ 
  scale_fill_manual(values = colors)+
  facet_wrap(.~file)
```


## Probabily for MCAR {.smaller}

We can create a missing data indicator variable `R1` to explore differences between the subjects with missing data and the subjects without missing data. 

```{r}
mcar <- mcar %>% mutate(R1 = is.na(X1))
```

```{r echo = FALSE}
mcarbox <- mcar %>% pivot_longer(cols = c(X2, X3), names_to = "variable", values_to = "value")

ggplot(data = mcarbox, aes(x = R1, y = value)) +
  geom_boxplot() +
  xlab("Missing data indicator (R1)") +
  facet_wrap(.~variable)


```


## Missing at random (MAR)

Missing data are MAR when the probability of missing data on a variable is related to some other measured variable in the model, but not to the value of the variable with missing values itself.

For example, older people more often have missing values for IQ. In that case the probability of missing data on IQ is related to age. 

<br>
<center><img src="images/577.jpg" height="270px" /></center>

## Complete data example {.smaller}

```{r echo = FALSE}
describe(x) %>% kable(caption = "Description of fully observed data", digits = 2) %>% kable_styling()
```


## MAR data example {.smaller}

When we create MAR data for 50% of the subject in variable `X1` we see that the statistics for variable `X1` have changed:
```{r}
set.seed(4665)
mar <- MAR(x, alpha = 0.5, pattern = matrix(c(0,1,1), nrow = 1))
```

```{r echo = FALSE}
describe(mar) %>% kable(caption = "Description of MAR data - 50% ", digits = 2) %>% kable_styling()
```

## MAR distribution

```{r echo=FALSE, message=FALSE, warning=FALSE}
marplot <- x %>% mutate(file = "complete") %>%
  bind_rows(mar %>% mutate(file = "mar"))
colors <- c("complete" = "blue", "mar" = "red")
ggplot(marplot, aes(x = X1, fill = file)) +
  geom_histogram( alpha = 0.5)+ 
  scale_fill_manual(values = colors)+
  facet_wrap(.~file)
```


## Probability of MAR {.smaller}

We can create a missing data indicator variable `R1` to explore differences between the subjects with missing data and the subjects without missing data. 

```{r}
mar <- mar %>% mutate(R1 = is.na(X1))
```

```{r echo = FALSE}
marbox <- mar %>% pivot_longer(cols = c(X2, X3), names_to = "variable", values_to = "value")

ggplot(data = marbox, aes(x = R1, y = value)) +
  geom_boxplot() +
  xlab("Missing data indicator (R1)") +
  facet_wrap(.~variable)

```

The difference between the group with missing values (TRUE) and the group without missing values (FALSE) shows that having missing data is related to the scores on the other variables. 


## Missing not at random (MNAR)

Data are MNAR when the missing values on a variable are related to the values of that variable itself, even after controlling for other variables. 

For example, when weight data are missing mostly for the more heavy persons.

<br>
<center><img src="images/40779.jpg" height="270px" /></center>


## Complete data example {.smaller}

```{r echo = FALSE}
describe(x) %>% kable(caption = "Description of fully observed data", digits = 2) %>% kable_styling()
```

## MNAR data example {.smaller}

When we create MNAR data for 50% of the subject in variable `X1` we see that the statistics for variable `X1` have changed:
```{r}
set.seed(5476)
mnar <- x %>% mutate(rand = runif(1000),
                     X1 = ifelse(X1 > 0 & rand > 0.2, NA, X1), 
                     X1 = ifelse(X1 < 0 & rand > 0.8, NA, X1)) %>%
  select(-rand)
```

```{r echo = FALSE}
describe(mnar) %>% kable(caption = "Description of MNAR data - 50% ", digits = 2) %>% kable_styling()
```


## MNAR distribution

```{r echo=FALSE, message=FALSE, warning=FALSE}
mnarplot <- x %>% mutate(file = "complete") %>%
  bind_rows(mnar %>% mutate(file = "mnar"))
colors <- c("complete" = "blue", "mnar" = "red")
ggplot(mnarplot, aes(x = X1, fill = file)) +
  geom_histogram( alpha = 0.5)+ 
  scale_fill_manual(values = colors)+
  facet_wrap(.~file)
```


## Probability of MNAR {.smaller}

We can create a missing data indicator variable `R1` to explore differences between the subjects with missing data and the subjects without missing data. 

```{r}
mnar <- mnar %>% mutate(R1 = is.na(X1))
```

```{r echo = FALSE}
mnarbox <- mnar %>% pivot_longer(cols = c(X2, X3), names_to = "variable", values_to = "value")

ggplot(data = mnarbox, aes(x = R1, y = value)) +
  geom_boxplot() +
  xlab("Missing data indicator (R1)") +
  facet_wrap(.~variable)

```

The difference between the group with missing values (TRUE) and the group without missing values (FALSE) shows that having missing data is related to the scores on the other variables. 


# Evaluate the missing data mechanism {data-background=Puzzle_zgnb3.jpg data-background-size=cover}

## Reason for missing data

Any information about the research process can provide valuable information that helps to evaluate and make assumptions about the missing data mechanism. 

Why are data missing?

<br>
<center><img src="images/3156627.jpg" height="270px" /></center>


## Missing data mechanisms

* **Missing completely at random:** missing data is a completely random subsample of the observed data. 
* **Missing at random:** probability of missing data is related to other measured variables.
* **Missing not at random:** probability of missing data is related to the missing data itself, and other measured variables.

## Testing the mechanisms {.build}

The missing data mechanisms are defined by the probability that missing data occur. 

Probability is not related to other measured variables 

* Assume the remaining sample is a totally random subsample (MCAR). 

*Other measured variables* are related tot the probability of missing data
 
 * Assume the data are not MCAR. However, we cannot definitively rule out MNAR, because we in practice we never know *the missing data itself*. 


## Statistical tests {.build}

The essence of testing for MCAR is to compare the group with missing data to the group without missing data. 

**Univariate testing**

* Independent samples t-test to compare for continuous measures
* Chi-square test to compare for categorical measures

**Multivariate testing**

* Logistic regression to evaluate multivariately
* Little's MCAR test

## T-test to evaluate MCAR

Independent samples T-test to compare the mean of *continuous* variables between the group with missing data to the group without missing data. 

Note that the T-test assumes normally distributed data and homogeneity of variance.

## T-test | MCAR example

```{R}
t.test(X2 ~ R1, data = mcar)

```

## T-test | MAR example

```{R}
t.test(X2 ~ R1, data = mar)

```

## T-test | MNAR example

```{R}
t.test(X2 ~ R1, data = mnar)

```


## T-test

Univariate method.

When there are no significant differences we may assume the data are MCAR. Otherwise, we assume not-MCAR (i.e. MAR or MNAR). 

*Note that we can never truly rule out MNAR.*


## Chi-square test to evaluate MCAR

Chi-square test to compare the *categorical* variables for the group with missing data to the group without missing data.

Test to compare the distribution over the categories between the groups. 

Note that the Chi-square test assumes that the expected cell frequencies should not be too small.

## Chi-square | MCAR example

```{R}
mcar <- mcar %>% mutate(X3c = ifelse(X3 > 0, 1, 0))
chisq.test(mcar$R1, mcar$X3c)

```


## Chi-square | MAR example

```{R}
mar <- mar %>% mutate(X3c = ifelse(X3 > 0, 1, 0))
chisq.test(mar$R1, mar$X3c)

```


## Chi-square | MNAR example

```{R}
mnar <- mar %>% mutate(X3c = ifelse(X3 > 0, 1, 0))
chisq.test(mar$R1, mnar$X3c)

```


## Logistic regression to evaluate MCAR

The probability of missing data can also be investigated in a logistic regression analysis.

The missing data indicator is the dependent variable and the other variables that may be related to the probability of missing data are the independent variables. 

The results of the logistic regression analysis show if the independent variables relate to the probability of missing data.

*Note that when the other variables have missing values as well, a complete-case analysis is used per default.* 


## Logistic regression | MCAR example

```{R}
glm(R1 ~ X2 + X3, data = mcar) %>%
  summary %>% coefficients %>% round(.,3)

``` 

## Logistic regression| MAR example

```{R}
glm(R1 ~ X2 + X3, data = mar) %>%
  summary %>% coefficients %>% round(.,3)

``` 

## Logistic regression | MNAR example 

```{R}
glm(R1 ~ X2 + X3, data = mnar) %>%
  summary %>% coefficients %>% round(.,3)
```

## Logistic regression

In the MCAR example both `X2` and `X3` are not related to the probability of missing data in `X1`, so we may assume that the missing data in `X1` are MCAR. 

However, in the MAR example, both variables are related tot he probability of missing data in `X1`, so in that case we can assume that the data are not-MCAR. 

We cannot rule-out MNAR in this situation, since cannot test the missing values itself. 


## Little's MCAR test

* A multivariate test that evaluates the subgroups of the data that share the same missing data pattern. 

* Per subgroup (with same missing data pattern): observed means versus estimated means based on the expectation-maximization algorithm. 

* Chi-square distribution test to test the null hypothesis that data are MCAR.

* A significant result shows that the data are not-MCAR.  


## Little's MCAR test | MCAR example

```{R}
misty::na.test(mcar %>% select(X1:X3))
```

## Little's MCAR test | MAR example

```{R}
misty::na.test(mar %>% select(X1:X3))
```

## Little's MCAR test | MNAR example

```{R }
misty::na.test(mnar %>% select(X1:X3))
```


## Little's MCAR test notes

* No specific information about which variables are related to the probability of missing data. 

* Test assumes multivariate normality and can only be applied to continuous variables.

* The MNAR mechanism can never be ruled out, regardless of the result of the test. 



<!--- 
Little (1988) proposed a multivariate test of Missing Completely at Random (MCAR) that tests for mean differences on every variable in the data set across subgroups that share the same missing data pattern by comparing the observed variable means for each pattern of missing data with the expected population means estimated using the expectation-maximization (EM) algorithm (i.e., EM maximum likelihood estimates). The test statistic is the sum of the squared standardized differences between the subsample means and the expected population means weighted by the estimated variance-covariance matrix and the number of observations within each subgroup (Enders, 2010). Under the null hypothesis that data are MCAR, the test statistic follows asymptotically a chi-square distribution with ∑ k_j - k degrees of freedom, where k_j is the number of complete variables for missing data pattern j, and k is the total number of variables. A statistically significant result provides evidence against MCAR.

Note that Little's MCAR test has a number of problems (see Enders, 2010). First, the test does not identify the specific variables that violates MCAR, i.e., the test does not identify potential correlates of missingness (i.e., auxiliary variables). Second, the test is based on multivariate normality, i.e., under departure from the normality assumption the test might be unreliable unless the sample size is large and is not suitable for categorical variables. Third, the test investigates mean differences assuming that the missing data pattern share a common covariance matrix, i.e., the test cannot detect covariance-based deviations from MCAR stemming from a Missing at Random (MAR) or Missing Not at Random (MNAR) mechanism because MAR and MNAR mechanisms can also produce missing data subgroups with equal means. Fourth, simulation studies suggest that Little's MCAR test suffers from low statistical power, particularly when the number of variables that violate MCAR is small, the relationship between the data and missingness is weak, or the data are MNAR (Thoemmes & Enders, 2007). Fifth, the test can only reject, but cannot prove the MCAR assumption, i.e., a statistically not significant result and failing to reject the null hypothesis of the MCAR test does not prove the null hypothesis that the data is MCAR. Finally, under the null hypothesis the data are actually MCAR or MNAR, while a statistically significant result indicates that missing data are MAR or MNAR, i.e., MNAR cannot be ruled out regardless of the result of the test.
--->


<!----

Example is not working!
### Jamshidian and Jalal's Non-Parametric MCAR Test

Jamshidian and Jalal's non-parametric MCAR test, solves some of the issues with Little's MCAR test. This test assumes that the missing data are either MCAR or MAR, and tests whether the missingness is independent of the observed values. If so, the covariance matrices of the imputed data will be equal across groups with different patterns of missingness. However, this test can only indicate whether missingness is MCAR or MAR. The procedure cannot distinguish MCAR from MNAR, so a non-significant result does not rule out MNAR.

This method does not work with just one missing data pattern (as our example data). Se we create a new example with two patterns.
*MCAR example*
```{r eval=FALSE, include=FALSE}
set.seed(879)
set.seed(8965)
mcar <- MCAR(x, alpha = 0.5, pattern = matrix(c(0,1,1, 1,0,0), nrow = 2))
mice::mcar(mcar)
```

This test consists of the following procedure:

Data are imputed.

The imputed data are split into k groups according to the k missing data patterns in the original data (see md.pattern()).

Perform Hawkins' test for equality of covariances across the k groups.

If the test is not significant, conclude that there is no evidence against multivariate normality of the data, nor against MCAR.

If the test is significant, and multivariate normality of the data can be assumed, then it can be concluded that missingness is MAR.

If multivariate normality cannot be assumed, then perform the Anderson-Darling non-parametric test for equality of covariances across the k groups.

If the Anderson-Darling test is not significant, this is evidence against multivariate normality - but no evidence against MCAR.

If the Anderson-Darling test is significant, this is evidence it can be concluded that missingness is MAR.


-->

## Assuming the missing data mechanism (MCAR) {.build}

The methods to deal with missing data, implicitly assume a missing data mechanism. 

**MCAR**: the most strict assumption. In practice it is also easiest to deal with MCAR data. 

1. Analyze the observed sample only (this will result in unbiased estimates).
2. Use an imputation method to boost the power the the amount of missing data is too large. 


## Assuming the missing data mechanism (MAR) {.build}

**MAR**: less strict assumption. Most advanced missing data methods assume this mechanism (e.g. multiple imputation, FIML). 

* Include variables in study that may explain the missing data, a MAR assumption may become more plausible (as compared to MNAR). 
* These auxiliary variables may also help in dealing with the missing data. 
* Auxiliary variables: variables related to the probability of missing data or to the variable with missing data. Can be used as predictors in an imputation model or as covariates in a FIML model to improve estimations.


## Assuming the missing data mechanism (MNAR) {.build}

**MNAR**: least strict assumption. 

* MNAR data are also referred to as non-ignorable, because these cannot be ignored without causing bias in results. MNAR data are more challenging to deal with. 


