---
title: "Missing value analysis"
subtitle: "Workshop name"
author: "Dr. Iris Eekhout"
date: "`r format(Sys.Date())`"
output: 
  ioslides_presentation:
    logo: Puzzle_zgnb3_m.jpg
    theme: readable
    css: eigencssfile.css
widescreen: true
always_allow_html: yes
---

# Missing value analysis {data-background=Puzzle_zgnb3.jpg data-background-size=cover}
  
## What are missing values

Missing observations are defined as `NA` in R. 

Missing data can have different implications for data summaries, analyses and conclusions based on the data with missing values. 


<img src="images/Wavy_Bus-09_Single-06.jpg" height="400px" />


## Amount of missing data

* Matrix perspective
* Variable perspective
* Case perspective

## Example data {.smaller}

<!--A data example is used to demonstrate the methods to explore missing values. 
. -->
The example data has 25 rows and 5 columns.

```{r echo=FALSE, message=FALSE, warning=FALSE}
#example data 
library(MASS)
library(dplyr)
library(tidyr)
library(mice)

cov <- matrix(c(rep(0.7, 25)), nrow = 5)
diag(cov) <- 1
dat <- MASS::mvrnorm(n = 25, rep(0,5), Sigma = cov)

patterns <- matrix(c(0,1,1,0,0,
                     1,0,1,1,0), nrow = 2, byrow = T)
set.seed(23421)
datm <- dmo::MCAR(data.frame(dat), alpha = 0.50, pattern = patterns, f = c(0.5, 0.5))
```

```{r echo = TRUE}
head(datm, 15)
```


## Matrix perspective {.smaller}


**Matrix perspective:** the number of missing entries in the data matrix. 

The `is.na` function returns `TRUE` if a cell is missing (`NA`) and `FALSE` if a cell is observed.

In the example there are `r sum(is.na(datm))` missing data entries. The data frame contains 5 variables for 25 subjects, which makes a total of 125 data entries. So, `r sum(is.na(datm))/length(is.na(datm)) *100`% of the data entries are missing.  

```{R}
sum(is.na(datm))

sum(is.na(datm))/length(is.na(datm))

```


## Variables perspective {.smaller}


**Variables perspective:** the number of missing values per variable.

For each variable we can count the number of missing observations (*n*) and calculate the proportion (*p*).


```{R}

datm %>%
  is.na %>%
  data.frame() %>%
  summarise_all(list(n = sum, p = mean)) %>%
  pivot_longer(everything(), 
               names_to = c("variable", ".value"),
               names_pattern = "(.*)_(.)")

```

## Case perspective {.smaller}


**Case perspective:** the number of rows, i.e. cases, with missing values.

Many analysis methods only use the rows that are fully observed: complete-case analysis. 

The data are then *listwise* deleted. 

```{r}

datm %>% 
  is.na %>%
  data.frame() %>%
  mutate(n_miss = rowSums(.),
         missing = ifelse(n_miss > 0, "rows with misings", "rows without missing")) %>%
  group_by(missing) %>%
  summarise(n = n(),
            p = n/ 25)


```


## Case perspective - `mice` {.smaller}


* `cci`: create an indicator for the number of fully observed rows. 

```{r}
mice::cci(datm)
```

* `nic`: count the number of incomplete cases, i.e. cases with missing values. 

```{R}

mice::nic(datm)
```

* `ncc`: count the number of complete cases, i.e. cases full fully observed rows.

```{R}
mice::ncc(datm)
```


## Missing data patterns {.smaller}


**Missing data pattern**: the combination of observed and unobserved values that occur together in a row. 
Generally notated as having a 0 for a missing value and a 1 for an observed value. 

Data often contains multiple different missing data patterns. The example shows three missing data patterns:

1. All variables are observed, so a row of only ones. 
2. Three variables observed and two missing.
3. Two variables observed and three missing. 

```{r}
mice::md.pattern(datm, plot= F)
``` 

*row-names: the number of times the pattern occurs in the data; last column: the number missing values the missing data pattern holds.* 


## Missing data pairs {.smaller}


**Missing data pair:** the number of times two variables are either missing together or observed together.

How many cases we can actually use for *imputation*.  The `md.pair` function from the `mice` package returns four matrices. Each matrix gives us information about combinations of missing values in our data. 

- **response-response (`rr`)** the count of how often two variables are both observed.
- **response-missing (`rm`)** the count of how often the row-variable is observed and the column-variable is missing.
- **missing-response (`mr`)** the count of how often the row-variable is missing and the column-variable is observed.
- **missing-missing (`mm`)** the count of how often two variables are both missing. 

```{r}
pat <- mice::md.pairs(datm)

```


## Response-response

Observed value counts.

```{r}
pat$rr
```

## Response-missing

Missing value counts when rows are observed.

```{r}
pat$rm
```

## Missing-response

Missing value counts when columns are observed.

```{r}
pat$mr
```

## Missing-missing

Missing value counts.

```{r}
pat$mm
```


## Information for imputation


The proportion missing-response from the sum of the missing-response and missing-missing matrices shows how many usable cases the data have to impute the row variable from the column variable. 

```{R} 

round(100 * pat$mr / (pat$mr + pat$mm))

```

*X3 has no missing values*

<!----
## Types of missing data

In research, missing data occur when a data value is unavailable. Many empirical studies encounter missing data. Missing data can occur in many stages of research due to many different causes in many different forms. 

- *Non-response*: an invited respondent does not participate in the study.
- *Intermittent missing data*: missing data on one or more of the measured variables that are used as a predictor, covariate or outcome.
- *drop-out* or *loss to follow-up*: participants in a longitudinal study do not show up at one or more repeated measurement occasions.

Each type of missing data may have different reasons, and also different implication for the methods to deal with the missing data. 
-->