---
title: "Longitudinal missing data"
author: "Dr. Iris Eekhout"
subtitle: "Workshop name"
date: "`r format(Sys.Date())`"
output: 
  ioslides_presentation:
    logo: Puzzle_zgnb3_m.jpg
    theme: readable
    css: eigencssfile.css
widescreen: true
always_allow_html: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
library(tidyr)
library(mice)


set.seed(28472)
wideex <- data.frame(id = 1:50,
           group = rep(c(0,1), 25),
           T0 = sample(15:25, 50, replace = T),
           T1 = sample(15:25, 50, replace = T),
           T2 = sample(15:25, 50, replace = T))

longex <- wideex %>% pivot_longer(cols = T0:T2, names_to = "time", values_to = "outcome")

#make missings
wideexm <- dmo::MCAR(wideex, alpha = 0.25, pattern = matrix(c(1,1,1,1,0,
                                                              1,1,1,0,0,
                                                              1,1,1,0,1,
                                                              1,1,0,1,0), byrow = T, ncol = 5), f = c(0.25,0.25,0.25,0.25))
wideexm <- data.frame(wideexm)
colnames(wideexm) <- colnames(wideex)

longexm <- wideexm %>% pivot_longer(cols = T0:T2, names_to = "time", values_to = "outcome") 

longexmc <- longexm %>%
  mutate(cov1 = runif(n()),
         cov2 = rnorm(n()),
         cov3 = rnorm(n()))

wideexmc <- longexmc %>%
  pivot_wider(id_cols = c(id, group), names_from = "time", values_from = c("outcome", "cov1", "cov2", "cov3"))
```

## Repeated measurements data

* In longitudinal studies people are monitored for a longer time period.
* For example RCT with follow-up
 + Baseline
 + Post-treatment
 + Follow-up
* Intensive longitudinal data: sensor measurements, daily measures

## Challenges

* Repeated measurements are correlated within persons: multilevel structure
* Measurement time-points some times do not line up

## Data structure

* Wide data format
  + One row per person, repeated measurements in the columns
* Long data format
  + Multiple rows per person, one column as time-point indicator
  
## Wide data format

```{R echo=FALSE}
wideex
```

## Example long data

```{R}
longex <- wideex %>% pivot_longer(cols = T0:T2, names_to = "time", values_to = "outcome")
longex
 
```

## Missing data in longitudinal designs

* Wide imputation
* Long imputation: multilevel imputation


## Wide data imputation

* Similar to multiple imputation on cross-sectional data
* Number of variables in imputation model may be a challenge


## Example wide imputation

Data set with measurements at three time-points for:

* outcome
* covariate 1
* covariate 2
* covariate 3
* one group variable

In total: 13 variables in wide imputation.

## Practical solutaion for wide imputation

* Leave out predictors from other time-points
* Example predictormatrix for outcome 

```{r}
### change to have covs for T0 to outcome T0 and covs for T1 to uotcome T1 etx.
wide_pred <- mice::make.predictorMatrix(wideexmc)
wide_pred[c("outcome_T0", "outcome_T1", "outcome_T2"),]
```