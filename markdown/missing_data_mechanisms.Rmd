---
title: "Missing data mechanisms"
author: "Iris Eekhout"
date: "5-3-2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dmo)
library(ggplot2)
#example dataset n = 100
library(MASS)
library(psych)
library(knitr)
library(kableExtra)
library(dplyr)
library(tidyr)
set.seed(7869)

x <- mvrnorm(n=1000,mu=c(0,0,0), Sigma=matrix(c(5,1,1,1,5,1,1,1,5),3,3)) %>% 
  data.frame() 

theme_set(theme_light())
```


In research, missing data occur when a data value is unavailable. Many empirical studies encounter missing data. Missing data can occur in many stages of research due to many different causes in many different forms. When invited respondents do not participate in the study there is *non-response*. It is also possible that for some particpants there are missing values in measured variables tahta are used as a predictor, covariate or outcome, i.e. *intermittend missing data*. When participants in a longitudinal study do not show up at one or more repeated measurement occasions, the missing data are often referred to as *drop-out* or *loss to follow up*. 

Each type of missing data may have different reasons, and also different implication for the methods to deal with the missing data. To get more insight in the missing data problem, the reasons for missing data are differentiated in several missing data mechanisms. These mechanisms describe the underlying cause of missing data and were first described by Rubin (1976). Rubin distinguished three missing data mechanisms: **missing completely at random (MCAR)**, **missing at random (MAR)**, and **missing not at random (MNAR)**. These missing data mechanisms are important since they are assumptions for the missing data methods. It must be noted that the missing data mechanisms are not characteristics of an entire data set, but the mechanisms are merely assumptions which apply to specific analyses methods. 


## Missing completely at random (MCAR)

Missing data are MCAR when the probability of missing data on a variable is unrelated to any other measured variable and is unrelated to the variable with missing values itself. In other words the missingness on the variable is completely unsystematic. For example questionnaire responses get lost in the mail. 


```{r echo = FALSE}
describe(x) %>% kable(caption = "Description of fully observed data", digits = 2) %>% kable_styling()
```

When we create MCAR data for 50% of the subject in variable `X1` we see that the statistics for variable `X1` have not changed much:
```{r}
set.seed(8965)
mcar <- MCAR(x, alpha = 0.5, pattern = matrix(c(0,1,1), nrow = 1))
```

```{r echo = FALSE}
describe(mcar) %>% kable(caption = "Description of MCAR data - 50% ", digits = 2) %>% kable_styling()
```

The distribution of the fully observed version of the variable is depicted in blue and the remaining data due to missings is red. As a result the missing part of the data are the blue parts of the graph. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
mcarplot <- x %>% mutate(file = "complete") %>%
  bind_rows(mcar %>% mutate(file = "mcar"))
colors <- c("complete" = "blue", "mcar" = "red")
ggplot(mcarplot, aes(x = X1, fill = file)) +
  geom_histogram( alpha = 0.5)+ 
  scale_fill_manual(values = colors)+
  facet_wrap(.~file)
```

We can create a missing data indicator variable `R1` to explore differences between the subjects with missing data and the subjects without missing data. 

```{r}
mcar <- mcar %>% mutate(R1 = is.na(X1))
```

```{r echo = FALSE}
mcarbox <- mcar %>% pivot_longer(cols = c(X2, X3), names_to = "variable", values_to = "value")

ggplot(data = mcarbox, aes(x = R1, y = value)) +
  geom_boxplot() +
  xlab("Missing data indicator (R1)") +
  facet_wrap(.~variable)


```

Missing completely at random (MCAR) is the only missing data mechanism that can actually be verified. This assumption can be tested by separating the missing and the complete cases and examine the group characteristics. If characteristics are not equal for both groups, the MCAR assumption does not hold. 


## Missing at random (MAR)

Missing data are missing at random (MAR) when the probability of missing data on a variable is related to some other measured variable in the model, but not to the value of the variable with missing values itself. For example, only younger people have missing values for IQ. In that case the probability of missing data on IQ is related to age. The assumption that the mechanism is MAR, can unfortunately not be confirmed, because it cannot be tested if the probability of missing data on a variable is solely a function of other measured variables. It is recommended to incorporate correlates of missingness into the missing data handling procedure to diminish bias and improve the chances of satisfying the MAR assumption.



```{r echo = FALSE}
describe(x) %>% kable(caption = "Description of fully observed data", digits = 2) %>% kable_styling()
```

When we create MAR data for 50% of the subject in variable `X1` we see that the statistics for variable `X1` have changed:
```{r}
set.seed(4665)
mar <- MAR(x, alpha = 0.5, pattern = matrix(c(0,1,1), nrow = 1))
```

```{r echo = FALSE}
describe(mar) %>% kable(caption = "Description of MAR data - 50% ", digits = 2) %>% kable_styling()
```

The distribution of the fully observed version of the variable is depicted in blue and the remaining data due to missings is red. We can compare the two distributions. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
marplot <- x %>% mutate(file = "complete") %>%
  bind_rows(mar %>% mutate(file = "mar"))
colors <- c("complete" = "blue", "mar" = "red")
ggplot(marplot, aes(x = X1, fill = file)) +
  geom_histogram( alpha = 0.5)+ 
  scale_fill_manual(values = colors)+
  facet_wrap(.~file)
```

We can create a missing data indicator variable `R1` to explore differences between the subjects with missing data and the subjects without missing data. 

```{r}
mar <- mar %>% mutate(R1 = is.na(X1))
```

The difference between the group with missing values (TRUE) and the group without missing values (FALSE) shows that having missing data is related to the scores on the other variables. 

```{r echo = FALSE}
marbox <- mar %>% pivot_longer(cols = c(X2, X3), names_to = "variable", values_to = "value")

ggplot(data = marbox, aes(x = R1, y = value)) +
  geom_boxplot() +
  xlab("Missing data indicator (R1)") +
  facet_wrap(.~variable)

```




## Missing not at random (MNAR)

Data are missing not at random (MNAR) when the missing values on a variable are related to the values of that variable itself, even after controlling for other variables. For example, when data are missing on IQ and only the people with low IQ values have missing observations for this variable. A problem with the MNAR mechanism is that it is impossible to verify that scores are MNAR without knowing the missing values.


```{r echo = FALSE}
describe(x) %>% kable(caption = "Description of fully observed data", digits = 2) %>% kable_styling()
```

When we create MNAR data for 50% of the subject in variable `X1` we see that the statistics for variable `X1` have changed:
```{r}
set.seed(5476)
mnar <- x %>% mutate(rand = runif(1000),
                     X1 = ifelse(X1 > 0 & rand > 0.2, NA, X1), 
                     X1 = ifelse(X1 < 0 & rand > 0.8, NA, X1)) %>%
  select(-rand)
```

```{r echo = FALSE}
describe(mnar) %>% kable(caption = "Description of MNAR data - 50% ", digits = 2) %>% kable_styling()
```

The distribution of the fully observed version of the variable is depicted in blue and the remaining data due to missings is red. We can compare the two distributions and see that missings occurred mostly in the higher values of `X1`. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
mnarplot <- x %>% mutate(file = "complete") %>%
  bind_rows(mnar %>% mutate(file = "mnar"))
colors <- c("complete" = "blue", "mnar" = "red")
ggplot(mnarplot, aes(x = X1, fill = file)) +
  geom_histogram( alpha = 0.5)+ 
  scale_fill_manual(values = colors)+
  facet_wrap(.~file)
```

We can create a missing data indicator variable `R1` to explore differences between the subjects with missing data and the subjects without missing data. 

```{r}
mnar <- mnar %>% mutate(R1 = is.na(X1))
```

The difference between the group with missing values (TRUE) and the group without missing values (FALSE) shows that having missing data is related to the scores on the other variables. 

```{r echo = FALSE}
mnarbox <- mnar %>% pivot_longer(cols = c(X2, X3), names_to = "variable", values_to = "value")

ggplot(data = mnarbox, aes(x = R1, y = value)) +
  geom_boxplot() +
  xlab("Missing data indicator (R1)") +
  facet_wrap(.~variable)

```



## Evaluate the missing data mechanism

Any information about the research process can provide valuable information that helps to evaluate and make assumptions about the missing data mechanism. By what is known about the data collection process and the data in general, most researchers have an idea about the reasons for the missing data. It is very important to take this knowledge into account when making an assumption about the missing data mechanism.

### Missing data mechanisms

* **Missing completely at random:** missing data is a completely random subsample of the observed data. 
* **Missing at random:** probability of missing data is related to other measured variables.
* **Missing not at random:** probability of missing data is related to the missing data itself, and other measured variables.

### Testing the mechanisms

The missing data mechanisms are defined by the probability that missing data occur. When this probability is totally not related to other measured variables, we can assume that the remaining sample is a totally random subsample (MCAR). 

When *other measured variables* are related tot the probability of missing data, we can assume that the data are not MCAR. However, we can never definitively distinct between MAR or MNAR, because we in practice we never know *the missing data itself*. 


### Statistical tests

The essence of testing for MCAR is to compare the group with missing data to the group without missing data. We can use simple statistics tests to do this. 

**Univariate testing**
* Independent samples t-test to compare for contiuous measures
* Chi-square test to compare for categorical measures

**Multivariate testing**
* Logistic regression to evaluate multivariately

### T-test to evaluate MCAR

To compare the continuous variables for the group with missing data to the group without missing data, we can use a T-test to compare the means between the groups. 

*MCAR example*
```{R}
t.test(X2 ~ R1, data = mcar)

```

*MAR example*
```{R}
t.test(X2 ~ R1, data = mar)

```

Usually, you do this for all variables in the data that you suspect can be related to the probability of missing data. When there are no significant differences we may assume the data are MCAR. Otherwise, we assume not-MCAR (i.e. MAR or MNAR).

### Chi-square test to evaluate MCAR

To compare the categorical variables for the group wiht missing data to the grop without missing data, we can use a Chi-square test to compare the distribution over the categories between the groups. 

*MCAR example*
```{R}
mcar <- mcar %>% mutate(X3c = ifelse(X3 > 0, 1, 0))
chisq.test(mcar$R1, mcar$X3c)

```

*MAR example*
```{R}
mar <- mar %>% mutate(X3c = ifelse(X3 > 0, 1, 0))
chisq.test(mar$R1, mar$X3c)

```


### Logistic regression to evaluate MCAR



### Little's MCAR test

The data can be separated into two groups, one group with participants with complete data on variable A (e.g., IQ) and one group with participants with missing data on variable A (e.g., IQ). We can create a dichotomous variable (i.e, missing data indicator) that indicates whether data on IQ are missing or complete. Then we can test for group differences with a t-test. For example we can test whether both groups differ in age. If there are differences we can conclude that our missing data are NOT complete at random, so not MCAR. We can also use the missing data indicator variable as outcome in a logistic regression model and test whether other variables in the data are related to that outcome. If we find variables related to the missing data indicator we can conclude that data are not MCAR. If we find no relations at all, we might be able to conclude that missing data are MCAR. However, we can never distinguish between MAR or MNAR. We can only test if data are MCAR or not MCAR. Furthermore, it is always important to combine statistical testing with common sense.
